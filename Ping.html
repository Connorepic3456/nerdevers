// ... [Keep your Firebase Config and Initializations as they are] ...

// 1. Updated Manual Ban Function with Auto-Cleanup
window.manualBan = function(ipKey) {
    if(confirm("Are you sure you want to ban this IP?")) {
        // Add to blacklist
        blacklistRef.child(ipKey).set({ 
            bannedAt: firebase.database.ServerValue.TIMESTAMP, 
            reason: "Manual Admin Ban" 
        }).then(() => {
            // Optional: Clean up their online presence immediately from the admin view
            console.log("User banned successfully.");
        });
    }
};

// 2. Modified Online Users Listener
// This ensures that as soon as you ban someone, the list updates
function loadAdminData() {
    blacklistRef.on('value', (snap) => {
        banList.innerHTML = "";
        snap.forEach((child) => {
            const ipKey = child.key;
            const item = document.createElement('div');
            item.className = 'list-item';
            item.innerHTML = `
                <span>${ipKey.replace(/_/g, '.')}</span>
                <button class="unban-btn" onclick="unbanUser('${ipKey}')">Unban</button>
            `;
            banList.appendChild(item);
        });
    });

    onlineRef.on('value', (snap) => {
        deviceList.innerHTML = "";
        snap.forEach((child) => {
            const data = child.val();
            const ipKey = data.ipKey;
            
            // Skip rendering if this user is already in the blacklist
            blacklistRef.child(ipKey).once('value', (banSnap) => {
                if (!banSnap.exists()) {
                    const item = document.createElement('div');
                    item.className = 'list-item';
                    const actionHtml = (ipKey !== userIP) 
                        ? `<button class="ban-btn" onclick="manualBan('${ipKey}')">Ban IP</button>` 
                        : `<span style="color:#60a5fa; font-weight:bold;">(YOU)</span>`;
                    
                    item.innerHTML = `
                        <div>
                            <span class="device-info">${data.device || 'Unknown'}</span><br>
                            <small style="color:#4b5563">${ipKey.replace(/_/g, '.')}</small>
                        </div>
                        <div class="action-btns">${actionHtml}</div>
                    `;
                    deviceList.appendChild(item);
                }
            });
        });
    });
}

// 3. Force "Kick" on Banned Users
// This listener runs for every user; if their IP appears in blacklist, they are locked out instantly
function setupBanListener(currentIP) {
    blacklistRef.child(currentIP).on('value', (snapshot) => {
        if (snapshot.exists()) {
            isBanned = true;
            btn.disabled = true;
            btn.classList.remove('ready');
            btn.innerText = "BANNED";
            status.style.color = "#ef4444";
            status.innerText = "ACCESS REVOKED BY ADMIN";
            
            // Remove them from the online list since they are no longer active
            myPresenceRef.remove(); 
        } else {
            // Handle unban in real-time
            if (isBanned) {
                isBanned = false;
                btn.disabled = false;
                btn.innerText = audioUnlocked ? "PING" : "TAP ME";
                status.style.color = "#94a3b8";
                status.innerText = audioUnlocked ? "ONLINE" : "Click once to enable sound!";
                if (audioUnlocked) btn.classList.add('ready');
            }
        }
    });
}

// 4. Update the IP Fetching block to include the new listener
fetch('https://api.ipify.org?format=json')
    .then(res => res.json())
    .then(data => {
        const rawIP = data.ip;
        userIP = rawIP.replace(/\./g, '_');
        
        // Start watching for ban status immediately
        setupBanListener(userIP);

        adminsRef.once('value', (snapshot) => {
            if (!snapshot.exists()) {
                adminsRef.child(userIP).set({
                    addedAt: firebase.database.ServerValue.TIMESTAMP,
                    role: "Master"
                });
                alert("Setup Complete: You are now the Admin!");
                location.reload();
            } else if (snapshot.hasChild(userIP)) {
                adminPanel.style.display = 'block';
                loadAdminData();
            }
        });
    });
